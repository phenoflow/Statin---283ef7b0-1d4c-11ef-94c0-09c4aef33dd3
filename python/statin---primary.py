# Ellie Paige, Jessica Barret, David Stevens, Ruth H Keogh, Michael J Sweeting, Irwin Nazareth, Irene Peterson, Angela M Wood, 2024.

import sys, csv, re

codes = [{"code":"86795998","system":"readv2"},{"code":"61213979","system":"readv2"},{"code":"90309998","system":"readv2"},{"code":"97455979","system":"readv2"},{"code":"88534998","system":"readv2"},{"code":"93619997","system":"readv2"},{"code":"94831990","system":"readv2"},{"code":"93243996","system":"readv2"},{"code":"57838979","system":"readv2"},{"code":"58661979","system":"readv2"},{"code":"95450990","system":"readv2"},{"code":"92409998","system":"readv2"},{"code":"95442990","system":"readv2"},{"code":"90310998","system":"readv2"},{"code":"94789990","system":"readv2"},{"code":"95501990","system":"readv2"},{"code":"81051998","system":"readv2"},{"code":"87917998","system":"readv2"},{"code":"92804996","system":"readv2"},{"code":"61212979","system":"readv2"},{"code":"83030998","system":"readv2"},{"code":"95487990","system":"readv2"},{"code":"61215979","system":"readv2"},{"code":"92805997","system":"readv2"},{"code":"81050998","system":"readv2"},{"code":"81048998","system":"readv2"},{"code":"95406990","system":"readv2"},{"code":"95480990","system":"readv2"},{"code":"93243998","system":"readv2"},{"code":"95508990","system":"readv2"},{"code":"92471998","system":"readv2"},{"code":"86789998","system":"readv2"},{"code":"89311998","system":"readv2"},{"code":"93244996","system":"readv2"},{"code":"95451990","system":"readv2"},{"code":"95486990","system":"readv2"},{"code":"95495990","system":"readv2"},{"code":"94849990","system":"readv2"},{"code":"91194998","system":"readv2"},{"code":"94830990","system":"readv2"},{"code":"93244998","system":"readv2"},{"code":"97476979","system":"readv2"},{"code":"92220998","system":"readv2"},{"code":"94927990","system":"readv2"},{"code":"89153996","system":"readv2"},{"code":"62597979","system":"readv2"},{"code":"89306996","system":"readv2"},{"code":"62570979","system":"readv2"},{"code":"95405990","system":"readv2"},{"code":"92154990","system":"readv2"},{"code":"86787998","system":"readv2"},{"code":"58654979","system":"readv2"},{"code":"89153998","system":"readv2"},{"code":"93619996","system":"readv2"},{"code":"95475990","system":"readv2"},{"code":"61489979","system":"readv2"},{"code":"86794998","system":"readv2"},{"code":"57832979","system":"readv2"},{"code":"95550990","system":"readv2"},{"code":"97377979","system":"readv2"},{"code":"79254979","system":"readv2"},{"code":"95502990","system":"readv2"},{"code":"97508979","system":"readv2"},{"code":"92539998","system":"readv2"},{"code":"95478990","system":"readv2"},{"code":"86020998","system":"readv2"},{"code":"95449990","system":"readv2"},{"code":"93871990","system":"readv2"},{"code":"94407990","system":"readv2"},{"code":"95481990","system":"readv2"},{"code":"93244997","system":"readv2"},{"code":"95483990","system":"readv2"},{"code":"86791998","system":"readv2"},{"code":"92410998","system":"readv2"},{"code":"89306998","system":"readv2"},{"code":"95472990","system":"readv2"},{"code":"95482990","system":"readv2"},{"code":"89311996","system":"readv2"},{"code":"95471990","system":"readv2"},{"code":"89154996","system":"readv2"},{"code":"94851990","system":"readv2"},{"code":"95279990","system":"readv2"},{"code":"94782990","system":"readv2"},{"code":"89153997","system":"readv2"},{"code":"86467998","system":"readv2"},{"code":"95500990","system":"readv2"},{"code":"92448997","system":"readv2"},{"code":"83099998","system":"readv2"},{"code":"86798998","system":"readv2"},{"code":"95551990","system":"readv2"},{"code":"89154998","system":"readv2"},{"code":"81049998","system":"readv2"},{"code":"86797998","system":"readv2"},{"code":"92447998","system":"readv2"},{"code":"86468998","system":"readv2"},{"code":"95443990","system":"readv2"},{"code":"93620998","system":"readv2"},{"code":"95479990","system":"readv2"},{"code":"93243997","system":"readv2"},{"code":"58669979","system":"readv2"},{"code":"87373998","system":"readv2"},{"code":"86796998","system":"readv2"},{"code":"89306997","system":"readv2"},{"code":"95549990","system":"readv2"},{"code":"97494979","system":"readv2"},{"code":"58671979","system":"readv2"},{"code":"95474990","system":"readv2"},{"code":"87918998","system":"readv2"},{"code":"89154997","system":"readv2"},{"code":"95277990","system":"readv2"},{"code":"95448990","system":"readv2"},{"code":"94850990","system":"readv2"},{"code":"92805998","system":"readv2"},{"code":"97705979","system":"readv2"},{"code":"57833979","system":"readv2"},{"code":"92804997","system":"readv2"},{"code":"86788998","system":"readv2"},{"code":"64839979","system":"readv2"},{"code":"99957979","system":"readv2"},{"code":"93620997","system":"readv2"},{"code":"92448998","system":"readv2"},{"code":"87418998","system":"readv2"},{"code":"93619998","system":"readv2"},{"code":"93620996","system":"readv2"},{"code":"92804998","system":"readv2"},{"code":"95278990","system":"readv2"},{"code":"90973998","system":"readv2"},{"code":"89311997","system":"readv2"},{"code":"87916998","system":"readv2"},{"code":"95445990","system":"readv2"},{"code":"92408998","system":"readv2"},{"code":"95493990","system":"readv2"},{"code":"95185990","system":"readv2"},{"code":"95494990","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('statin-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["statin---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["statin---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["statin---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
